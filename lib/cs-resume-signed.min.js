!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("nodefilereader"),require("xmlhttprequest"),require("spark-md5"),require("q"),require("node-blob"),require("xmldom")):"function"==typeof define&&define.amd?define("cloudStorageSignedResumer",["nodefilereader","xmlhttprequest","spark-md5","q","node-blob","xmldom"],t):"object"==typeof exports?exports.cloudStorageSignedResumer=t(require("nodefilereader"),require("xmlhttprequest"),require("spark-md5"),require("q"),require("node-blob"),require("xmldom")):e.cloudStorageSignedResumer=t(e.FileReader,e.window,e.SparkMD5,e.Q,e.Blob,e.window)}(window||this,(function(e,t,n,r,o,i){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=6)}([function(t,n){t.exports=e},function(e,n){e.exports=t},function(e,t){e.exports=n},function(e,t){e.exports=r},function(e,t){e.exports=o},function(e,t){e.exports=i},function(e,t,n){n(7),e.exports=n(10)},function(e,t,n){(function(t,n){!function(t){"use strict";var r,o=Object.prototype.hasOwnProperty,i="function"==typeof Symbol&&Symbol.iterator||"@@iterator",a="object"==typeof e,u=t.regeneratorRuntime;if(u)a&&(e.exports=u);else{(u=t.regeneratorRuntime=a?e.exports:{}).wrap=h;var s="suspendedStart",c="suspendedYield",l="executing",f="completed",p={},d=g.prototype=m.prototype;w.prototype=d.constructor=g,g.constructor=w,w.displayName="GeneratorFunction",u.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===w||"GeneratorFunction"===(t.displayName||t.name))},u.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,g):e.__proto__=g,e.prototype=Object.create(d),e},u.awrap=function(e){return new b(e)},v(E.prototype),u.async=function(e,t,n,r){var o=new E(h(e,t,n,r));return u.isGeneratorFunction(t)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},v(d),d[i]=function(){return this},d.toString=function(){return"[object Generator]"},u.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var r=t.pop();if(r in e)return n.value=r,n.done=!1,n}return n.done=!0,n}},u.values=P,S.prototype={constructor:S,reset:function(e){if(this.prev=0,this.next=0,this.sent=r,this.done=!1,this.delegate=null,this.tryEntries.forEach(L),!e)for(var t in this)"t"===t.charAt(0)&&o.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=r)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(n,r){return a.type="throw",a.arg=e,t.next=n,!!r}for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r],a=i.completion;if("root"===i.tryLoc)return n("end");if(i.tryLoc<=this.prev){var u=o.call(i,"catchLoc"),s=o.call(i,"finallyLoc");if(u&&s){if(this.prev<i.catchLoc)return n(i.catchLoc,!0);if(this.prev<i.finallyLoc)return n(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return n(i.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return n(i.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&o.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var i=r;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=e,a.arg=t,i?this.next=i.finallyLoc:this.complete(a),p},complete:function(e,t){if("throw"===e.type)throw e.arg;"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=e.arg,this.next="end"):"normal"===e.type&&t&&(this.next=t)},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),L(n),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;L(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:P(e),resultName:t,nextLoc:n},p}}}function h(e,t,n,o){var i=Object.create((t||m).prototype),a=new S(o||[]);return i._invoke=function(e,t,n){var o=s;return function(i,a){if(o===l)throw new Error("Generator is already running");if(o===f){if("throw"===i)throw a;return T()}for(;;){var u=n.delegate;if(u){if("return"===i||"throw"===i&&u.iterator[i]===r){n.delegate=null;var d=u.iterator.return;if(d)if("throw"===(h=y(d,u.iterator,a)).type){i="throw",a=h.arg;continue}if("return"===i)continue}var h;if("throw"===(h=y(u.iterator[i],u.iterator,a)).type){n.delegate=null,i="throw",a=h.arg;continue}if(i="next",a=r,!(m=h.arg).done)return o=c,m;n[u.resultName]=m.value,n.next=u.nextLoc,n.delegate=null}if("next"===i)n._sent=a,n.sent=o===c?a:r;else if("throw"===i){if(o===s)throw o=f,a;n.dispatchException(a)&&(i="next",a=r)}else"return"===i&&n.abrupt("return",a);if(o=l,"normal"===(h=y(e,t,n)).type){o=n.done?f:c;var m={value:h.arg,done:n.done};if(h.arg!==p)return m;n.delegate&&"next"===i&&(a=r)}else"throw"===h.type&&(o=f,i="throw",a=h.arg)}}}(e,n,a),i}function y(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}function m(){}function w(){}function g(){}function v(e){["next","throw","return"].forEach((function(t){e[t]=function(e){return this._invoke(t,e)}}))}function b(e){this.arg=e}function E(e){function t(t,n){var r=e[t](n),a=r.value;return a instanceof b?Promise.resolve(a.arg).then(o,i):Promise.resolve(a).then((function(e){return r.value=e,r}))}"object"==typeof n&&n.domain&&(t=n.domain.bind(t));var r,o=t.bind(e,"next"),i=t.bind(e,"throw");t.bind(e,"return");this._invoke=function(e,n){function o(){return t(e,n)}return r=r?r.then(o,o):new Promise((function(e){e(o())}))}}function x(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function L(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function S(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(x,this),this.reset(!0)}function P(e){if(e){var t=e[i];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(o.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=r,t.done=!0,t};return a.next=a}}return{next:T}}function T(){return{value:r,done:!0}}}("object"==typeof t?t:"object"==typeof window?window:"object"==typeof self?self:this)}).call(this,n(8),n(9))},function(e,t){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t){var n,r,o=e.exports={};function i(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}function u(e){if(n===setTimeout)return setTimeout(e,0);if((n===i||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:i}catch(e){n=i}try{r="function"==typeof clearTimeout?clearTimeout:a}catch(e){r=a}}();var s,c=[],l=!1,f=-1;function p(){l&&s&&(l=!1,s.length?c=s.concat(c):f=-1,c.length&&d())}function d(){if(!l){var e=u(p);l=!0;for(var t=c.length;t;){for(s=c,c=[];++f<t;)s&&s[f].run();f=-1,t=c.length}s=null,l=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===a||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function h(e,t){this.fun=e,this.array=t}function y(){}o.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];c.push(new h(e,t)),1!==c.length||l||u(d)},h.prototype.run=function(){this.fun.apply(null,this.array)},o.title="browser",o.browser=!0,o.env={},o.argv=[],o.version="",o.versions={},o.on=y,o.addListener=y,o.once=y,o.off=y,o.removeListener=y,o.removeAllListeners=y,o.emit=y,o.prependListener=y,o.prependOnceListener=y,o.listeners=function(e){return[]},o.binding=function(e){throw new Error("process.binding is not supported")},o.cwd=function(){return"/"},o.chdir=function(e){throw new Error("process.chdir is not supported")},o.umask=function(){return 0}},function(e,t,n){"use strict";n.r(t),n.d(t,"MD5Hash",(function(){return E})),n.d(t,"Uploader",(function(){return x}));var r=n(1),o=n.n(r),i=n(2),a=n.n(i),u=n(3),s=n.n(u),c=n(0),l=n.n(c),f=n(4),p=n.n(f),d=n(5),h=n.n(d);const y=o.a.XMLHttpRequest,m=h.a.DOMParser;var w="undefined"!=typeof File?File.prototype.slice||File.prototype.mozSlice||File.prototype.webkitSlice:{call(e,t,n){let r=p.a.prototype.slice.call(e,t,n);return r.name=e.name,r.size=n-t,r.type=e.type,r}};const g=2*Math.pow(1024,2),v=function(e,{onProgress:t}={}){return new Promise((n,r)=>{(function(e,t){var n=new l.a,r=s.a.defer(),o=new a.a,i=Math.ceil(e.size/t),u=0,c=(new Date).getTime();function f(){var r=u*t,o=Math.min(r+t,e.size);n.readAsBinaryString(w.call(e,r,o),u)}return n.onload=function(e){u+=1,r.notify({currentPart:u,totalParts:i});var t=e.target.result;o.appendBinary(t),u<i?f():r.resolve({hashResult:o.end(),duration:(new Date).getTime()-c})},n.onerror=function(e){r.reject(e)},f(),r.promise})(e,g).then((function(e){n(e)}),(function(e){r(e)}),(function(n){t&&"function"==typeof t&&onprogress({currentPart:n.currentPart,totalParts:n.totalParts,currentBytes:n.currentPart*g,totalBytes:e.size})}))})},b={},E=v,x=function({signedURI:e,uploadURI:t,file:n}){const r={EMPTY:0,UPLOAD_STARTED:1,SET_DISCONNECT_CALLED:2,DISCONNECTED:3,PAUSE_CALLED:5,PAUSED:6,UPLOAD_FINISHED:7};let o=null,i=null,a=null;function u(e){a=e}const s={disconnect:()=>{},uploadstarted:()=>{},uploadfinished:()=>{},progress:()=>{},finished:()=>{},cancelupload:()=>{},uploaderror:()=>{},uploadpaused:()=>{}};function c(e){s[e](...Array.from(arguments).slice(1))}function f(e,i){return new Promise((s,f)=>{const p=new y;p.onreadystatechange=function(){if(4===p.readyState&&200===p.status)o=null,s();else if(4===p.readyState&&308===p.status)o=null,s();else if(4===p.readyState)switch(o=null,a){case r.PAUSE_CALLED:u(r.PAUSED),s();break;case r.SET_DISCONNECT_CALLED:u(r.DISCONNECTED),s();break;default:0===p.status?(c("disconnected"),f()):f("UNKNOW_ERROR")}},p.open("PUT",t,!0),p.setRequestHeader("Content-Range",`bytes ${e}-${e+i.size-1}/${n.size}`),p.upload&&(p.upload.onprogress=function(t){t.lengthComputable&&c("progress",(e+t.loaded)/n.size)}),function(e){return new Promise((t,n)=>{var r=new l.a;r.onload=function(e){t(e.target.result)},r.onerror=function(e){n(e)},r.readAsArrayBuffer(e)})}(i).then(e=>{p.send(e),o=p}).catch(e=>{c("uploaderror",e)})})}this.on=(e,t)=>{if("string"!=typeof e)throw"event should be string";if("function"!=typeof t)throw new"callback should be a function";Object.keys(s).indexOf(e.toLowerCase())&&(s[e.toLowerCase()]=t)},this.cancelUpload=()=>{if(null===o||null===i)throw"Upload not started";o.abort(),o=null,delete b[i],i=null,c("cancelupload")},this.pause=()=>{if(null===o||null===i)throw"Upload not started";u(r.PAUSE_CALLED),o.abort(),o=null,c("uploadpaused")},this.setDisconnected=()=>{null!==o&&null!==i&&(u(r.SET_DISCONNECT_CALLED),o.abort(),o=null,c("disconnected"))},this.upload=()=>{(async()=>{try{let u=0;if(!i){const{hashResult:e}=await v(n);i=e}if(t||(b[i]?t=b[i]:(t=await new Promise((t,r)=>{const o=new y;o.onreadystatechange=function(){if(4===o.readyState&&201===o.status)t(o.getResponseHeader("Location"));else if(4===o.readyState&&400===o.status){const e=new m;xmlDoc=e.parseFromString(o.responseText,"text/xml"),r("GetUploadURI: "+xmlDoc.getElementsByTagName("Error")[0].getElementsByTagName("Message")[0].childNodes[0].nodeValue)}else 4===o.readyState&&r("GetUploadURI: unknow response")},o.open("POST",e,!0),o.setRequestHeader("x-goog-resumable","start"),o.setRequestHeader("Content-Type",n.type),o.send()}),b[i]=t)),t&&"string"==typeof t){const e=await new Promise((e,r)=>{const i=new y;i.onreadystatechange=function(){if(4===i.readyState&&308===i.status){const t=i.getResponseHeader("Range");e(null===t?{started:!1,finished:!1}:{started:!0,finished:!1,alreadySentBytes:parseInt(t.split("-")[1])})}else 4===i.readyState&&200===i.status?e({started:!0,finished:!0}):4===i.readyState&&(o=null,c("disconnect"),r("checkUploadStatusError"))},i.open("PUT",t,!0),i.setRequestHeader("Content-Range",`bytes */${n.size}`),i.send()});if(e.finished)return void c("uploadfinished");e.started&&(u=e.alreadySentBytes+1)}await function(e){return new Promise(async(o,u)=>{try{let u=1024*10*1024;u-=u%256*1024;let s=n.size-e,l=Math.ceil(s/u),p=null,d=w.call(n,e,Math.min(n.size,e+u));a=r.UPLOAD_STARTED,c("uploadstarted",{hash:i,progress:e/n.size,uploadURI:t});for(let t=0;t<l;t++){if(p=d,a===r.PAUSED){o();break}let i=e+t*u;await Promise.all([f(i,p),new Promise(r=>{if(t+1===l)r();else{let o=e+(t+1)*u,i=Math.min(n.size,o+u);d=w.call(n,o,Math.min(n.size,i)),r()}})])}a===r.UPLOAD_STARTED&&(i=null,a=r.UPLOAD_FINISHED),o()}catch(e){u(e)}})}(u),a===r.UPLOAD_FINISHED&&(c("uploadfinished"),delete b[i])}catch(e){console.error(e)}})()}}}])}));